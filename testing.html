<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Table Viewer</title>
    <link rel="stylesheet" href="rooms.css" />
    <style>
        .controls {
            display: flex;
            gap: 10px;
            padding: 10px;
            background: #f0f0f0;
        }

        .description-card {
            border: 1px solid #ddd;
            padding: 15px;
            max-width: 300px;
            position: absolute;
            right: 10px;
            top: 100px;
            background: white;
            border-radius: 5px;
        }

        .part-list {
            max-height: 150px;
            overflow-y: auto;
            margin: 10px 0;
        }

        .part-list button {
            display: block;
            width: 100%;
            padding: 5px;
            margin: 2px 0;
            background: #f0f0f0;
            border: none;
            cursor: pointer;
        }

        .part-list button:hover {
            background: #ddd;
        }

        .navigation {
            position: absolute;
            bottom: 10px;
            left: 10px;
        }
    </style>
</head>

<body>
    <!-- Controls for color, size, and object addition -->
    <div class="controls">
        <label for="colorPicker">Choose Table Color:</label>
        <input type="color" id="colorPicker" value="#b5651d" />

        <label for="sizeSlider">Table Size:</label>
        <input type="range" id="sizeSlider" min="0.5" max="2" step="0.1" value="1" />

        <label for="newObject">Add Object:</label>
        <select id="newObject">
            <option value="">Select an object</option>
            <option value="/public/table.glb">Table</option>
            <option value="/public/chair.glb">Chair</option>
        </select>
        <button id="addObjectBtn">Add</button>
    </div>

    <!-- Viewer and Description Side by Side -->
    <div class="viewer-container">
        <!-- 3D Model Viewer -->
        <model-viewer id="threedd" src="/public/modern_kitchen.glb" autoplay camera-controls auto-rotate
            shadow-intensity="1" exposure="1" environment-image="neutral" interaction-prompt="none" scale="1 1 1">
            <div id="partList" class="part-list" slot="hotspot-1"></div>
        </model-viewer>

        <!-- Table Description Card -->
        <div class="description-card">
            <h2>Table Model #12</h2>
            <p><strong>Type:</strong> Radial Work Table</p>
            <p><strong>Material:</strong> Solid Wood</p>
            <p><strong>Color:</strong> Customizable</p>
            <p><strong>Dimensions:</strong> Adjustable (via slider)</p>
            <p><strong>Price:</strong> $299.99</p>
            <p><strong>Description:</strong> A durable and spacious radial work table, ideal for modern workspaces or
                home offices. Adjustable in size and color to match your needs.</p>
        </div>
    </div>

    <!-- Navigation Buttons -->
    <div class="navigation">
        <a href="3dmodel2.html"><button>‚Üê Previous</button></a>
    </div>

    <!-- Load model-viewer -->
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/4.0.0/model-viewer.min.js"></script>

    <!-- Script to handle color change, size, and object addition/movement -->
    <script>
        const modelViewer = document.querySelector("model-viewer");
        const colorPicker = document.getElementById("colorPicker");
        const sizeSlider = document.getElementById("sizeSlider");
        const newObjectSelect = document.getElementById("newObject");
        const addObjectBtn = document.getElementById("addObjectBtn");
        const partList = document.getElementById("partList");

        let materials = [];
        let addedObjects = [];
        let selectedObject = null;
        let isDragging = false;

        // Load the model and list its parts
        modelViewer.addEventListener("load", () => {
            materials = modelViewer.model.materials;
            updatePartList();
        });

        // Function to list all parts of the model for color selection
        function updatePartList() {
            partList.innerHTML = "";
            materials.forEach((material, index) => {
                const button = document.createElement("button");
                button.textContent = material.name || `Part ${index + 1}`;
                button.addEventListener("click", () => {
                    selectedObject = null; // Clear any selected added object
                    applyColorToMaterial(index);
                });
                partList.appendChild(button);
            });
        }

        // Apply color to the selected material
        function applyColorToMaterial(materialIndex) {
            const material = materials[materialIndex];
            const color = colorPicker.value;
            material.pbrMetallicRoughness.setBaseColorFactor(hexToRgbA(color));
        }

        // Convert hex color to RGBA array
        function hexToRgbA(hex) {
            const r = parseInt(hex.substr(1, 2), 16) / 255;
            const g = parseInt(hex.substr(3, 2), 16) / 255;
            const b = parseInt(hex.substr(5, 2), 16) / 255;
            return [r, g, b, 1];
        }

        // Adjust the size of the main model
        sizeSlider.addEventListener("input", () => {
            const scaleValue = sizeSlider.value;
            modelViewer.setAttribute("scale", `${scaleValue} ${scaleValue} ${scaleValue}`);
        });

        // Add a new object to the scene
        addObjectBtn.addEventListener("click", () => {
            const objectSrc = newObjectSelect.value;
            if (!objectSrc) return;

            const newModelViewer = document.createElement("model-viewer");
            newModelViewer.setAttribute("src", objectSrc);
            newModelViewer.setAttribute("style", "position: absolute; width: 100px; height: 100px; top: 50%; left: 50%; transform: translate(-50%, -50%);");
            newModelViewer.setAttribute("camera-controls", "");
            newModelViewer.setAttribute("disable-zoom", "");
            document.body.appendChild(newModelViewer);

            addedObjects.push(newModelViewer);
            makeObjectDraggable(newModelViewer);
        });

        // Make an object draggable
        function makeObjectDraggable(obj) {
            obj.addEventListener("mousedown", (e) => {
                selectedObject = obj;
                isDragging = true;
            });

            document.addEventListener("mousemove", (e) => {
                if (isDragging && selectedObject) {
                    const x = e.clientX;
                    const y = e.clientY;
                    selectedObject.style.left = x + "px";
                    selectedObject.style.top = y + "px";
                }
            });

            document.addEventListener("mouseup", () => {
                isDragging = false;
                selectedObject = null;
            });

            // Allow color change for added objects
            obj.addEventListener("click", () => {
                selectedObject = obj;
                updatePartListForAddedObject(obj);
            });
        }

        // Update part list for an added object
        function updatePartListForAddedObject(obj) {
            obj.addEventListener("load", () => {
                materials = obj.model.materials;
                updatePartList();
            });
        }

        // Apply color to selected object if it's an added object
        colorPicker.addEventListener("input", () => {
            if (selectedObject && addedObjects.includes(selectedObject)) {
                updatePartListForAddedObject(selectedObject);
            }
        });
    </script>
</body>

</html>