<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FurniCraft - 3D Editor</title>
    <style>
        /* Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }
        
        header {
            background-color: #2c3e50;
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .logo {
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        nav ul {
            display: flex;
            list-style: none;
        }
        
        nav ul li {
            margin-left: 1.5rem;
        }
        
        nav ul li a {
            color: white;
            text-decoration: none;
            transition: color 0.3s;
        }
        
        nav ul li a:hover {
            color: #3498db;
        }
        
        /* Editor Main */
        .editor-main {
            padding: 2rem;
        }
        
        .editor-container {
            display: flex;
            gap: 2rem;
            height: calc(100vh - 150px);
        }
        
        .threejs-container {
            flex: 1;
            background-color: #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            position: relative;
        }
        
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        
        .editor-controls {
            width: 350px;
            background-color: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            overflow-y: auto;
        }
        
        /* Control Sections */
        .control-section {
            margin-bottom: 2rem;
        }
        
        .control-section h3 {
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #eee;
            color: #2c3e50;
        }
        
        /* Category Tabs */
        .category-tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .tab-btn {
            padding: 0.5rem 1rem;
            background-color: #eee;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .tab-btn.active {
            background-color: #3498db;
            color: white;
        }
        
        .tab-btn:hover:not(.active) {
            background-color: #ddd;
        }
        
        /* Furniture Items */
        .furniture-items {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }
        
        .furniture-item {
            background-color: #f9f9f9;
            border-radius: 4px;
            padding: 0.8rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid #ddd;
        }
        
        .furniture-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .furniture-item img {
            width: 100%;
            height: 80px;
            object-fit: contain;
            margin-bottom: 0.5rem;
        }
        
        /* Form Controls */
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }
        
        .form-group select, 
        .form-group input[type="range"] {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 0.7rem 1.5rem;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
            width: 100%;
            margin-top: 0.5rem;
        }
        
        .btn:hover {
            background-color: #2980b9;
        }
        
        #removeItem {
            background-color: #e74c3c;
        }
        
        #removeItem:hover {
            background-color: #c0392b;
        }
        
        footer {
            text-align: center;
            padding: 1rem;
            background-color: #2c3e50;
            color: white;
        }
        
        .texture-preview {
            width: 50px;
            height: 50px;
            display: inline-block;
            margin-right: 10px;
            border: 1px solid #ddd;
            vertical-align: middle;
        }
    </style>
</head>
<body>
    <header>
        <div class="logo">FurniCraft 3D Editor</div>
        <nav>
            <ul>
                <li><a href="index.html">Home</a></li>
                <li><a href="rooms.html">Rooms</a></li>
                <li><a href="#" id="saveDesign">Save Design</a></li>
            </ul>
        </nav>
    </header>

    <main class="editor-main">
        <div class="editor-container">
            <div class="threejs-container" id="modelViewer">
                <div class="loading-overlay" id="loadingOverlay">
                    <div>Loading room...</div>
                </div>
            </div>
            
            <div class="editor-controls">
                <div class="control-section">
                    <h3>Room Selection</h3>
                    <div class="form-group">
                        <label for="roomSelect">Current Room</label>
                        <select id="roomSelect">
                            <option value="living">Living Room</option>
                            <option value="bedroom">Bedroom</option>
                            <option value="kitchen">Kitchen</option>
                            <option value="office">Office</option>
                            <option value="dining">Dining Room</option>
                            <option value="patio">Outdoor Patio</option>
                        </select>
                    </div>
                </div>
                
                <div class="control-section">
                    <h3>Room Textures</h3>
                    <div class="item-properties">
                        <div class="form-group">
                            <label for="wallTexture">Wall Texture</label>
                            <select id="wallTexture">
                                <option value="default">Default</option>
                                <option value="brick">Brick</option>
                                <option value="wood-panel">Wood Panel</option>
                                <option value="paint-blue">Blue Paint</option>
                                <option value="paint-white">White Paint</option>
                            </select>
                            <div class="texture-preview" id="wallPreview"></div>
                        </div>
                        <div class="form-group">
                            <label for="floorTexture">Floor Texture</label>
                            <select id="floorTexture">
                                <option value="default">Default</option>
                                <option value="wood">Wood Floor</option>
                                <option value="tile">Tile</option>
                                <option value="carpet">Carpet</option>
                                <option value="marble">Marble</option>
                            </select>
                            <div class="texture-preview" id="floorPreview"></div>
                        </div>
                        <button class="btn" id="applyTextures">Apply Textures</button>
                    </div>
                </div>
                
                <div class="control-section">
                    <h3>Furniture Categories</h3>
                    <div class="category-tabs">
                        <button class="tab-btn active" data-category="all">All</button>
                        <button class="tab-btn" data-category="sofa">Sofa</button>
                        <button class="tab-btn" data-category="chair">Chair</button>
                        <button class="tab-btn" data-category="table">Table</button>
                    </div>
                    
                    <div class="furniture-items" id="furnitureItems">
                        <!-- Dynamically loaded from JS -->
                    </div>
                </div>
                
                <div class="control-section">
                    <h3>Selected Item</h3>
                    <div class="item-properties">
                        <div class="form-group">
                            <label for="itemSize">Size</label>
                            <select id="itemSize">
                                <option value="0.75">Small</option>
                                <option value="1" selected>Medium</option>
                                <option value="1.25">Large</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="itemColor">Color</label>
                            <select id="itemColor">
                                <option value="#ff0000">Red</option>
                                <option value="#0000ff">Blue</option>
                                <option value="#00ff00">Green</option>
                                <option value="#000000">Black</option>
                                <option value="#ffffff">White</option>
                                <option value="#8B4513">Brown</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="itemRotation">Rotation</label>
                            <input type="range" id="itemRotation" min="0" max="360" value="0">
                            <span id="rotationValue">0°</span>
                        </div>
                        <button class="btn" id="removeItem">Remove Item</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer>
        <p>&copy; 2023 FurniCraft. All rights reserved.</p>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/controls/DragControls.js"></script>
    
    <script>
        // Global variables
        let scene, camera, renderer, controls, dragControls;
        let roomModel = null;
        let selectedObject = null;
        let furnitureItems = [];
        let textureLoader = new THREE.TextureLoader();
        let currentRoom = null;
        
        // Sample furniture data
        const furnitureData = [
            { 
                id: 1, 
                name: "Modern Sofa", 
                category: "sofa", 
                gltfPath: "assets/models/chair/scene.gltf", 
                thumbnail: "rooms/living_room/lr.jpg" 
            },
            { 
                id: 2, 
                name: "Dining Chair", 
                category: "chair", 
                gltfPath: "rooms/living_room/miniroom.gltf", 
                thumbnail: "models/furniture/thumbnails/chair.jpg" 
            },
            { 
                id: 3, 
                name: "Coffee Table", 
                category: "table", 
                gltfPath: "models/furniture/table.gltf", 
                thumbnail: "models/furniture/thumbnails/table.jpg" 
            },
            { 
                id: 4, 
                name: "Armchair", 
                category: "chair", 
                gltfPath: "rooms/living_room/miniroom.gltf", 
                thumbnail: "models/furniture/thumbnails/armchair.jpg" 
            }
        ];
        
        // Room data with texture information
        const roomData = {
            living: { 
                name: "Living Room", 
                gltfPath: "rooms/living_room/miniroom.gltf", 
                thumbnail: "models/rooms/thumbnails/living.jpg",
                textures: {
                    wall: {
                        default: null,
                        brick: "rooms/living_room/miniroom.gltf",
                        "wood-panel": "assets/models/textures/Chair_baseColor.jpeg",
                        "paint-blue": "assets/models/textures/Chair_metallicRoughness.png",
                        "paint-white": "assets/models/textures/Chair_normal.png"
                    },
                    floor: {
                        default: null,
                        wood: "models/rooms/textures/wood_floor.jpg",
                        tile: "models/rooms/textures/tile.jpg",
                        carpet: "models/rooms/textures/carpet.jpg",
                        marble: "models/rooms/textures/marble.jpg"
                    }
                }
            },
            bedroom: { 
                name: "Bedroom", 
                gltfPath: "models/rooms/bedroom.gltf", 
                thumbnail: "models/rooms/thumbnails/bedroom.jpg",
                textures: {
                    wall: {
                        default: null,
                        brick: "models/rooms/textures/brick.jpg",
                        "wood-panel": "models/rooms/textures/wood_panel.jpg",
                        "paint-blue": "models/rooms/textures/blue_paint.jpg",
                        "paint-white": "models/rooms/textures/white_paint.jpg"
                    },
                    floor: {
                        default: null,
                        wood: "models/rooms/textures/wood_floor.jpg",
                        tile: "models/rooms/textures/tile.jpg",
                        carpet: "models/rooms/textures/carpet.jpg",
                        marble: "models/rooms/textures/marble.jpg"
                    }
                }
            },
            kitchen: { 
                name: "Kitchen", 
                gltfPath: "models/rooms/kitchen.gltf", 
                thumbnail: "models/rooms/thumbnails/kitchen.jpg",
                textures: {
                    wall: {
                        default: null,
                        brick: "models/rooms/textures/brick.jpg",
                        "wood-panel": "models/rooms/textures/wood_panel.jpg",
                        "paint-blue": "models/rooms/textures/blue_paint.jpg",
                        "paint-white": "models/rooms/textures/white_paint.jpg"
                    },
                    floor: {
                        default: null,
                        wood: "models/rooms/textures/wood_floor.jpg",
                        tile: "models/rooms/textures/tile.jpg",
                        carpet: "models/rooms/textures/carpet.jpg",
                        marble: "models/rooms/textures/marble.jpg"
                    }
                }
            },
            office: { 
                name: "Office", 
                gltfPath: "rooms/living_room/miniroom.gltf", 
                thumbnail: "models/rooms/thumbnails/office.jpg",
                textures: {
                    wall: {
                        default: null,
                        brick: "models/rooms/textures/brick.jpg",
                        "wood-panel": "models/rooms/textures/wood_panel.jpg",
                        "paint-blue": "models/rooms/textures/blue_paint.jpg",
                        "paint-white": "models/rooms/textures/white_paint.jpg"
                    },
                    floor: {
                        default: null,
                        wood: "models/rooms/textures/wood_floor.jpg",
                        tile: "models/rooms/textures/tile.jpg",
                        carpet: "models/rooms/textures/carpet.jpg",
                        marble: "models/rooms/textures/marble.jpg"
                    }
                }
            },
            dining: { 
                name: "Dining Room", 
                gltfPath: "rooms/living_room/miniroom.gltf", 
                thumbnail: "models/rooms/thumbnails/dining.jpg",
                textures: {
                    wall: {
                        default: null,
                        brick: "models/rooms/textures/brick.jpg",
                        "wood-panel": "models/rooms/textures/wood_panel.jpg",
                        "paint-blue": "models/rooms/textures/blue_paint.jpg",
                        "paint-white": "models/rooms/textures/white_paint.jpg"
                    },
                    floor: {
                        default: null,
                        wood: "models/rooms/textures/wood_floor.jpg",
                        tile: "models/rooms/textures/tile.jpg",
                        carpet: "models/rooms/textures/carpet.jpg",
                        marble: "models/rooms/textures/marble.jpg"
                    }
                }
            },
            patio: { 
                name: "Outdoor Patio", 
                gltfPath: "rooms/living_room/miniroom.gltf", 
                thumbnail: "models/rooms/thumbnails/patio.jpg",
                textures: {
                    wall: {
                        default: null,
                        brick: "models/rooms/textures/brick.jpg",
                        "wood-panel": "models/rooms/textures/wood_panel.jpg",
                        "paint-blue": "models/rooms/textures/blue_paint.jpg",
                        "paint-white": "models/rooms/textures/white_paint.jpg"
                    },
                    floor: {
                        default: null,
                        wood: "models/rooms/textures/wood_floor.jpg",
                        tile: "models/rooms/textures/tile.jpg",
                        carpet: "models/rooms/textures/carpet.jpg",
                        marble: "models/rooms/textures/marble.jpg"
                    }
                }
            }
        };

        // Initialize Three.js scene
        function initThreeJS() {
            // Create scene
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0xf0f0f0);
            
            // Create camera
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(5, 5, 5);
            
            // Create renderer
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(document.getElementById('modelViewer').clientWidth, document.getElementById('modelViewer').clientHeight);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            document.getElementById('modelViewer').appendChild(renderer.domElement);
            
            // Add orbit controls
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            
            // Add lights
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(5, 10, 7);
            directionalLight.castShadow = true;
            directionalLight.shadow.mapSize.width = 1024;
            directionalLight.shadow.mapSize.height = 1024;
            scene.add(directionalLight);
            
            // Add grid helper
            const gridHelper = new THREE.GridHelper(20, 20);
            scene.add(gridHelper);
            
            // Load default room
            loadRoom('living');
            
            // Handle window resize
            window.addEventListener('resize', onWindowResize);
            
            // Start animation loop
            animate();
        }
        
        // Load room model
        function loadRoom(roomId) {
            const loadingOverlay = document.getElementById('loadingOverlay');
            loadingOverlay.style.display = 'flex';
            
            const room = roomData[roomId];
            if (!room) {
                console.error('Room not found:', roomId);
                loadingOverlay.style.display = 'none';
                return;
            }
            
            currentRoom = room;
            
            // Remove existing room if present
            if (roomModel) {
                scene.remove(roomModel);
                roomModel = null;
            }
            
            // Remove all furniture
            furnitureItems.forEach(item => scene.remove(item));
            furnitureItems = [];
            selectedObject = null;
            
            const loader = new THREE.GLTFLoader();
            
            console.log('Loading room:', room.gltfPath);
            
            loader.load(
                room.gltfPath,
                function (gltf) {
                    console.log('Room loaded successfully:', room.name);
                    roomModel = gltf.scene;
                    scene.add(roomModel);
                    
                    // Enable shadows for all meshes in the room
                    roomModel.traverse(function(child) {
                        if (child.isMesh) {
                            child.castShadow = true;
                            child.receiveShadow = true;
                        }
                    });
                    
                    // Center the room
                    centerObject(roomModel);
                    
                    // Initialize drag controls for furniture
                    initDragControls();
                    
                    loadingOverlay.style.display = 'none';
                    
                    // Update room select dropdown
                    document.getElementById('roomSelect').value = roomId;
                },
                function (xhr) {
                    // Progress callback
                    console.log((xhr.loaded / xhr.total * 100) + '% loaded');
                },
                function (error) {
                    console.error('Error loading room:', error);
                    loadingOverlay.style.display = 'none';
                    
                    // Create a placeholder cube if loading fails
                    const geometry = new THREE.BoxGeometry(5, 5, 5);
                    const material = new THREE.MeshBasicMaterial({ 
                        color: 0xff0000,
                        wireframe: true 
                    });
                    roomModel = new THREE.Mesh(geometry, material);
                    scene.add(roomModel);
                    
                    alert('Failed to load room model. Showing placeholder.');
                }
            );
        }
        
        // Center an object in the scene
        function centerObject(object) {
            const box = new THREE.Box3().setFromObject(object);
            const center = box.getCenter(new THREE.Vector3());
            const size = box.getSize(new THREE.Vector3());
            
            // Center the object
            object.position.x -= center.x;
            object.position.y -= center.y;
            object.position.z -= center.z;
            
            // Scale to reasonable size if needed
            const maxDim = Math.max(size.x, size.y, size.z);
            const scale = 5 / maxDim;
            object.scale.set(scale, scale, scale);
        }
        
        // Initialize drag controls for furniture
        function initDragControls() {
            if (dragControls) {
                dragControls.deactivate();
                dragControls.dispose();
            }
            
            dragControls = new THREE.DragControls(
                furnitureItems,
                camera,
                renderer.domElement
            );
            
            dragControls.addEventListener('dragstart', function (event) {
                controls.enabled = false;
                selectObject(event.object);
            });
            
            dragControls.addEventListener('dragend', function () {
                controls.enabled = true;
            });
            
            dragControls.addEventListener('drag', function (event) {
                // Snap to grid while dragging
                event.object.position.y = 0; // Keep on ground
                event.object.position.x = Math.round(event.object.position.x * 2) / 2;
                event.object.position.z = Math.round(event.object.position.z * 2) / 2;
            });
        }
        
        // Load furniture item
        function loadFurnitureItem(itemPath, position = new THREE.Vector3(0, 0, 0)) {
            const loader = new THREE.GLTFLoader();
            
            loader.load(
                itemPath,
                function (gltf) {
                    const model = gltf.scene;
                    
                    // Position the furniture
                    position.y = 0; // Ensure it's on the ground
                    model.position.copy(position);
                    
                    // Set furniture properties
                    model.userData = {
                        isFurniture: true,
                        originalMaterials: {}
                    };
                    
                    // Store original materials for color changes
                    model.traverse(function (child) {
                        if (child.isMesh) {
                            model.userData.originalMaterials[child.uuid] = child.material.clone();
                            child.castShadow = true;
                            child.receiveShadow = true;
                        }
                    });
                    
                    scene.add(model);
                    furnitureItems.push(model);
                    selectObject(model);
                    
                    // Update drag controls with new furniture
                    initDragControls();
                },
                undefined,
                function (error) {
                    console.error('Error loading furniture:', error);
                    alert('Failed to load furniture model.');
                }
            );
        }
        
        // Change texture for walls or floors
        function changeTexture(textureType, textureName) {
            if (!roomModel || !currentRoom || !currentRoom.textures[textureType]) return;
            
            const texturePath = currentRoom.textures[textureType][textureName];
            
            if (texturePath) {
                textureLoader.load(
                    texturePath,
                    function(texture) {
                        texture.wrapS = texture.wrapT = THREE.RepeatWrapping;
                        texture.repeat.set(2, 2);
                        
                        roomModel.traverse(function(child) {
                            if (child.isMesh) {
                                // Simple way - just change all materials
                                // For production, you'd want to identify specific walls/floors
                                if (textureType === 'wall' && child.name.includes('wall')) {
                                    child.material.map = texture;
                                    child.material.needsUpdate = true;
                                } else if (textureType === 'floor' && child.name.includes('floor')) {
                                    child.material.map = texture;
                                    child.material.needsUpdate = true;
                                }
                            }
                        });
                        
                        // Update texture preview
                        updateTexturePreview(textureType, texture);
                    },
                    undefined,
                    function(error) {
                        console.error('Error loading texture:', error);
                    }
                );
            } else {
                // Reset to default texture
                roomModel.traverse(function(child) {
                    if (child.isMesh) {
                        if (textureType === 'wall' && child.name.includes('wall')) {
                            child.material.map = null;
                            child.material.needsUpdate = true;
                        } else if (textureType === 'floor' && child.name.includes('floor')) {
                            child.material.map = null;
                            child.material.needsUpdate = true;
                        }
                    }
                });
                
                // Clear texture preview
                document.getElementById(`${textureType}Preview`).style.backgroundImage = 'none';
            }
        }
        
        // Update texture preview thumbnail
        function updateTexturePreview(textureType, texture) {
            const previewElement = document.getElementById(`${textureType}Preview`);
            const imageUrl = texture.image.currentSrc || texture.image.src;
            previewElement.style.backgroundImage = `url(${imageUrl})`;
            previewElement.style.backgroundSize = 'cover';
        }
        
        // Select object
        function selectObject(object) {
            if (selectedObject) {
                // Remove previous selection highlight
                selectedObject.traverse(function (child) {
                    if (child.isMesh && child.userData.originalEmissive !== undefined) {
                        child.material.emissive.setHex(child.userData.originalEmissive);
                    }
                });
            }
            
            selectedObject = object;
            
            if (selectedObject) {
                // Highlight selected object
                selectedObject.traverse(function (child) {
                    if (child.isMesh) {
                        child.userData.originalEmissive = child.material.emissive.getHex();
                        child.material.emissive.setHex(0x888888);
                    }
                });
                
                // Update UI controls
                updateControls();
            }
        }
        
        // Update UI controls based on selected object
        function updateControls() {
            if (!selectedObject) return;
            
            // Update rotation slider
            const rotationDegrees = THREE.MathUtils.radToDeg(selectedObject.rotation.y);
            document.getElementById('itemRotation').value = rotationDegrees;
            document.getElementById('rotationValue').textContent = `${Math.round(rotationDegrees)}°`;
            
            // Update size dropdown
            const size = selectedObject.scale.x;
            document.getElementById('itemSize').value = size.toFixed(2);
        }
        
        // Handle window resize
        function onWindowResize() {
            const container = document.getElementById('modelViewer');
            camera.aspect = container.clientWidth / container.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(container.clientWidth, container.clientHeight);
        }
        
        // Animation loop
        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }
        
        // Initialize furniture items in UI
        function initFurnitureUI() {
            const container = document.getElementById('furnitureItems');
            
            furnitureData.forEach(item => {
                const itemElement = document.createElement('div');
                itemElement.className = 'furniture-item';
                itemElement.dataset.id = item.id;
                itemElement.dataset.category = item.category;
                itemElement.innerHTML = `
                    <img src="${item.thumbnail}" alt="${item.name}" onerror="this.src='data:image/svg+xml;charset=UTF-8,<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"100\" height=\"100\" viewBox=\"0 0 100 100\"><rect fill=\"%23ddd\" width=\"100\" height=\"100\"/><text fill=\"%23666\" font-family=\"sans-serif\" font-size=\"12\" dy=\"4\" text-anchor=\"middle\" x=\"50\" y=\"50\">No Preview</text></svg>'">
                    <div>${item.name}</div>
                `;
                
                itemElement.addEventListener('click', () => {
                    // Position new furniture in front of camera
                    const position = new THREE.Vector3();
                    camera.getWorldDirection(position);
                    position.multiplyScalar(3);
                    position.y = 0;
                    
                    loadFurnitureItem(item.gltfPath, position);
                });
                
                container.appendChild(itemElement);
            });
        }
        
        // Initialize category tabs
        function initCategoryTabs() {
            const tabs = document.querySelectorAll('.tab-btn');
            
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    // Update active tab
                    tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    // Filter furniture items
                    const category = tab.dataset.category;
                    const items = document.querySelectorAll('.furniture-item');
                    
                    items.forEach(item => {
                        if (category === 'all' || item.dataset.category === category) {
                            item.style.display = 'block';
                        } else {
                            item.style.display = 'none';
                        }
                    });
                });
            });
        }
        
        // Initialize texture previews
        function initTexturePreviews() {
            // Wall textures
            const wallSelect = document.getElementById('wallTexture');
            wallSelect.innerHTML = '';
            
            Object.keys(roomData.living.textures.wall).forEach(textureKey => {
                const option = document.createElement('option');
                option.value = textureKey;
                option.textContent = textureKey === 'default' ? 'Default' : 
                                     textureKey.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase());
                wallSelect.appendChild(option);
            });
            
            // Floor textures
            const floorSelect = document.getElementById('floorTexture');
            floorSelect.innerHTML = '';
            
            Object.keys(roomData.living.textures.floor).forEach(textureKey => {
                const option = document.createElement('option');
                option.value = textureKey;
                option.textContent = textureKey === 'default' ? 'Default' : 
                                     textureKey.replace(/\b\w/g, l => l.toUpperCase());
                floorSelect.appendChild(option);
            });
        }
        
        // Initialize event listeners
        function initEventListeners() {
            // Room selection
            document.getElementById('roomSelect').addEventListener('change', (e) => {
                loadRoom(e.target.value);
            });
            
            // Apply textures button
            document.getElementById('applyTextures').addEventListener('click', () => {
                const wallTexture = document.getElementById('wallTexture').value;
                const floorTexture = document.getElementById('floorTexture').value;
                
                if (wallTexture !== 'default') {
                    changeTexture('wall', wallTexture);
                }
                
                if (floorTexture !== 'default') {
                    changeTexture('floor', floorTexture);
                }
            });
            
            // Remove item button
            document.getElementById('removeItem').addEventListener('click', () => {
                if (selectedObject && selectedObject.userData.isFurniture) {
                    scene.remove(selectedObject);
                    furnitureItems = furnitureItems.filter(item => item !== selectedObject);
                    selectedObject = null;
                    initDragControls();
                }
            });
            
            // Size control
            document.getElementById('itemSize').addEventListener('change', (e) => {
                if (selectedObject) {
                    const scale = parseFloat(e.target.value);
                    selectedObject.scale.set(scale, scale, scale);
                }
            });
            
            // Color control
            document.getElementById('itemColor').addEventListener('change', (e) => {
                if (selectedObject) {
                    const color = new THREE.Color(e.target.value);
                    selectedObject.traverse(function (child) {
                        if (child.isMesh && selectedObject.userData.originalMaterials[child.uuid]) {
                            const material = selectedObject.userData.originalMaterials[child.uuid].clone();
                            material.color = color;
                            child.material = material;
                        }
                    });
                }
            });
            
            // Rotation control
            document.getElementById('itemRotation').addEventListener('input', (e) => {
                if (selectedObject) {
                    const rotation = (e.target.value * Math.PI) / 180;
                    selectedObject.rotation.y = rotation;
                    document.getElementById('rotationValue').textContent = `${e.target.value}°`;
                }
            });
            
            // Save design
            document.getElementById('saveDesign').addEventListener('click', () => {
                // In a real app, you would save the scene state to a database
                const design = {
                    room: document.getElementById('roomSelect').value,
                    furniture: furnitureItems.map(item => ({
                        model: furnitureData.find(f => f.gltfPath === item.userData.modelPath)?.id,
                        position: { x: item.position.x, y: item.position.y, z: item.position.z },
                        rotation: item.rotation.y,
                        scale: item.scale.x,
                        color: item.children[0]?.material?.color.getHex()
                    })),
                    textures: {
                        wall: document.getElementById('wallTexture').value,
                        floor: document.getElementById('floorTexture').value
                    }
                };
                
                console.log('Design to save:', design);
                alert('Design saved to console. Implement your save functionality here.');
            });
            
            // Click on scene to select objects
            renderer.domElement.addEventListener('click', (event) => {
                if (event.target !== renderer.domElement) return;
                
                const mouse = new THREE.Vector2();
                mouse.x = (event.clientX / renderer.domElement.clientWidth) * 2 - 1;
                mouse.y = -(event.clientY / renderer.domElement.clientHeight) * 2 + 1;
                
                const raycaster = new THREE.Raycaster();
                raycaster.setFromCamera(mouse, camera);
                
                const intersects = raycaster.intersectObjects(furnitureItems, true);
                
                if (intersects.length > 0) {
                    let selected = intersects[0].object;
                    
                    // Find the parent furniture object
                    while (selected.parent && !selected.userData.isFurniture) {
                        selected = selected.parent;
                    }
                    
                    if (selected.userData.isFurniture) {
                        selectObject(selected);
                    }
                } else {
                    selectObject(null);
                }
            });
        }
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', () => {
            initThreeJS();
            initFurnitureUI();
            initCategoryTabs();
            initTexturePreviews();
            initEventListeners();
        });
    </script>
</body>
</html>